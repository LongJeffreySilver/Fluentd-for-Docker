<source>
  @type systemd
  path /var/log/journal
  <storage>
    @type local
    persistent true
    path /fluentd/log/fluentd-journal-pos.json
  </storage>
  tag systemd
</source>

<source>
  @type tail
  path /var/log/syslog
  pos_file /fluentd/log/fluentd-syslog.pos
  tag syslog
  format syslog
</source>

#Exponer métricas en formato Prometheus mediante HTTP para que las scrapee el propio Prometheus. NO hace falta un "match" porque
#es el propio Prometheus el que se encarga de venir a buscarlas.
<source>
  @type prometheus
  # La dirección y puerto donde se expondrán las métricas.
  # Por defecto las métricas estarán disponibles en /metrics
  bind 0.0.0.0
  port 24231
</source>

#Metricas internas de Fluentd
<source>
  @type monitor_agent
  #@id in_monitor_agent
  tag internal_metrics_fluentd
  bind 0.0.0.0
  port 24220
</source>

#  <source>
#   @type exec
#   command free -m
#   tag system.mem
#   interval 10
#   format /^(?<total>\d+)\s+(?<used>\d+)\s+(?<free>\d+)/
# </source>

# <match system.mem>
#   @type prometheus
#   <metric>
#     name system_memory_used
#     type gauge
#     desc Memory used in MB
#     key used
#   </metric>
#   <metric>
#     name system_memory_free
#     type gauge
#     desc Memory free in MB
#     key free
#   </metric>
# </match>  
#FIXME Para hacer lo de las metricas de host se necesita un script de python o sacar a mano cada metrica y luego tratarla mediante un match. Si los datos
#vienen de una única función, se pueden luego filtrar con un "filter" para generar un tag de cada metrica que coger para el match. 

<match internal_metrics_fluentd>
  @type prometheus
  <metric>
    name fluentd_output_status_buffer_queue_length
    type gauge
    desc La longitud de la cola del buffer para las salidas.
    label tag
    key buffer_queue_length
  </metric>
</match>



# Si luego quieres añadir logs de contenedores Docker, podrías añadir otra fuente con in_tail apuntando a /var/lib/docker/containers/*/*.log
# y aplicar el filtro docker_metadata.

<match systemd>
  @type stdout
</match>

<match syslog>
  @type stdout
</match>

